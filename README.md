# spring-with-distributed-lock
분산락 적용시 트러블 슈팅

>분산락을 테스트하기 위한 코드기 때문에 아키텍처나 테스트 방식은 편한방식으로 시도하였음

## 영속성 컨텐스트 이슈
어찌보면 당연한건데 require_new를 통한 분산락 적용시 분산락 적용한 메서드 이전에 호출한 엔티티들은 분산락 적용 메서드에서 CUD를 해도 변경 되지 않는다.
왜냐하면 require_new를 통해 새로운 트랜잭션이 생성될떄 해당 메서드에서는 다른 영속성 컨텍스트가 적용 된다.

### 해결방안
1. 비즈니스 로직 변경
   * 변경이 발생할 엔티티들을 분산락이 적용된 메서드에서 조회하고 업데이트를 진행했다. 
   * 레이어드 아키텍처에서는 비즈니스로직을 변경해서 해당 이슈를 해결했다.
   * 다만 반복문을 통해 분산락이 적용된 메서드를 호출한다면, 한번의 조회로 해결될 로직이 반복문의 횟수만큼 추가적으로 발생하는건 성능상의 이슈로 생각됐다.
2. domain 계층의 entity model 추가
   * 해당 클래스의 추가로 비즈니스로직이 jpa의 영향을 받지 않고 원하는 시점에 업데이트를 할 수 있게 함.
